version: '3.8'

# Production Docker Compose Configuration
# Ports are internal-only except for Nginx (80/443)
# Override: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # TimescaleDB - Internal only
  timescaledb:
    ports: []  # Remove public port exposure
    
  # PgBouncer - Internal only
  pgbouncer:
    ports: []  # Remove public port exposure
    
  # Redis - Internal only
  redis:
    ports: []  # Remove public port exposure
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD}
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    
  # RabbitMQ - Internal only
  rabbitmq:
    ports: []  # Remove public port exposure
    
  # FastAPI - Internal only
  api:
    ports: []  # Remove public port exposure
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/0
      RABBITMQ_URL: ${RABBITMQ_URL}
      KITE_API_KEY: ${KITE_API_KEY}
      KITE_API_SECRET: ${KITE_API_SECRET}
      KITE_ACCESS_TOKEN: ${KITE_ACCESS_TOKEN}
      ENVIRONMENT: production
      LOG_LEVEL: ${LOG_LEVEL}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      DOMAIN: ${DOMAIN}
    
  # Frontend - Internal only
  frontend:
    ports: []  # Remove public port exposure
    
  # Ingestion Service
  ingestion:
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/0
      RABBITMQ_URL: ${RABBITMQ_URL}
      KITE_API_KEY: ${KITE_API_KEY}
      INSTRUMENTS: ${INSTRUMENTS}
      LOG_LEVEL: ${LOG_LEVEL}
      DOMAIN: ${DOMAIN}
      ENVIRONMENT: production
    
  # Celery Worker - Scale to 3 replicas in production
  worker:
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/0
      RABBITMQ_URL: ${RABBITMQ_URL}
      BATCH_SIZE: ${BATCH_SIZE}
      BATCH_TIMEOUT: ${BATCH_TIMEOUT}
      LOG_LEVEL: ${LOG_LEVEL}
    deploy:
      replicas: 3  # Increased for production
    
  # Celery Beat
  beat:
    environment:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/0
      RABBITMQ_URL: ${RABBITMQ_URL}
      LOG_LEVEL: ${LOG_LEVEL}
    
  # Flower - Internal only (access via Nginx proxy)
  flower:
    ports: []  # Remove public port exposure
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/0
      RABBITMQ_URL: ${RABBITMQ_URL}
    
  # Prometheus - Internal only
  prometheus:
    ports: []  # Remove public port exposure
    
  # Grafana - Internal only (access via Nginx proxy)
  grafana:
    ports: []  # Remove public port exposure
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: false
      GF_SERVER_DOMAIN: ${DOMAIN}
      GF_SERVER_ROOT_URL: https://${DOMAIN}/grafana
    
  # Nginx - Only public-facing service
  nginx:
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.prod.conf:/etc/nginx/conf.d/default.conf
      - ./ssl:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    
  # Certbot - SSL certificate management
  certbot:
    volumes:
      - ./ssl:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

# Use named volumes with backup labels in production
volumes:
  pgdata:
    driver: local
    labels:
      backup: "daily"
  redisdata:
    driver: local
    labels:
      backup: "daily"
  rabbitmqdata:
    driver: local
    labels:
      backup: "daily"
  prometheusdata:
    driver: local
  grafanadata:
    driver: local

networks:
  tradingapp-network:
    driver: bridge
